version: 2.1

executors:
  php-executor:
    docker:
      - image: cimg/php:<<parameters.php-version>>-browsers
      - image: redis:alpine
    parameters:
      php-version:
        type: string
        default: "8.2"
    working_directory: ~/laravel-super-cache

jobs:
  test:
    parameters:
      php-version:
        type: string
      laravel-version:
        type: string
    executor:
      name: php-executor
      php-version: <<parameters.php-version>>
    steps:
      - checkout
      - run:
          name: Check if Redis extension is already loaded
          command: |
            if php -m | grep -q redis; then
              echo "Redis extension is already loaded, skipping installation"
            else
              echo "Redis extension not found, installing..."
              yes 'no' | sudo pecl install -f redis || true
              sudo docker-php-ext-enable redis
            fi
      - run:
          name: Install Dependencies with Laravel <<parameters.laravel-version>>
          command: |
            composer require "laravel/framework:^<<parameters.laravel-version>>.0" "illuminate/support:^<<parameters.laravel-version>>.0" --no-update --no-interaction
            composer install --prefer-dist --no-interaction
      - run:
          name: Prepare bootstrap/cache directory
          command: mkdir -p ./vendor/orchestra/testbench-core/laravel/bootstrap/cache && chmod -R 777 ./vendor/orchestra/testbench-core/laravel/bootstrap/cache

      - run:
          name: Run Tests
          command: |
            vendor/bin/phpunit

workflows:
  version: 2
  test:
    jobs:
      - test:
          name: PHP 8.2 + Laravel 10
          php-version: "8.2"
          laravel-version: "10"
      - test:
          name: PHP 8.2 + Laravel 11
          php-version: "8.2"
          laravel-version: "11"
      - test:
          name: PHP 8.3 + Laravel 10
          php-version: "8.3"
          laravel-version: "10"
      - test:
          name: PHP 8.3 + Laravel 11
          php-version: "8.3"
          laravel-version: "11"
      - test:
          name: PHP 8.3 + Laravel 12
          php-version: "8.3"
          laravel-version: "12"
      - test:
          name: PHP 8.4 + Laravel 11
          php-version: "8.4"
          laravel-version: "11"
      - test:
          name: PHP 8.4 + Laravel 12
          php-version: "8.4"
          laravel-version: "12"
      - test:
          name: PHP 8.5 + Laravel 12
          php-version: "8.5"
          laravel-version: "12"
