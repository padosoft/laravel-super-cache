# Laravel Super Cache - Copilot Context & Session Notes

## Package Overview

**Purpose**: Advanced Redis caching package for Laravel with tag support, namespacing, and sharding capabilities.

**Package Type**: Composer Library/Package (NOT an application)

**Key Features**:
- Tag-based cache invalidation with sharding
- Optional namespace support for key distribution
- Redis cluster and standalone support
- Advanced mode for tag tracking
- Pipeline operations for performance

## Important: Composer Lock File Policy

**CRITICAL**: This is a Composer **package/library**, NOT an application.

**Best Practice**:
- ✅ **DO** commit `composer.json` - Defines flexible dependency constraints
- ❌ **DO NOT** commit `composer.lock` - Should be generated by consuming applications
- ✅ `composer.lock` is in `.gitignore`

**Why?**
- Packages should allow flexible dependency resolution within declared version ranges
- Lock file in a package forces specific dependency versions during CI/CD
- This causes CI failures when testing against different Laravel versions (e.g., ^9.0|^10.0|^11.0|^12.0)
- Each consuming application generates its own lock file based on the package's constraints

**Reference**: [Composer Documentation - Libraries](https://getcomposer.org/doc/02-libraries.md#lock-file)

**Previous Issue**: 
- `composer.lock` had Laravel 12.7.2, causing CircleCI to fail when testing Laravel 10/11
- Error: "Required package 'laravel/framework' is in the lock file as 'v12.7.2' but that does not satisfy your constraint '^10.0'"
- Solution: Remove `composer.lock` from repository entirely

## Architecture

### Core Components

1. **SuperCacheManager** (`src/SuperCacheManager.php`)
   - Main cache manager with tag and namespace support
   - Methods: `put()`, `putWithTags()`, `get()`, `rememberWithTags()`, `forget()`, `flush()`
   - Uses `RedisConnector` for Redis connections
   - Implements sharding for tags (configurable via `num_shards`)

2. **RedisConnector** (`src/RedisConnector.php`)
   - Manages Laravel Redis connections
   - Provides native Redis connection for advanced operations
   - Handles pipeline operations

3. **Configuration** (`config/supercache.php`)
   - `prefix`: Cache key prefix
   - `num_shards`: Number of shards per tag (default: 16)
   - `use_namespace`: Enable/disable namespace distribution
   - `num_namespace`: Number of namespaces (default: 16)
   - `advancedMode`: Track tags for each key

### Key Concepts

**Namespacing**: 
- When enabled, keys are distributed across namespaces using CRC32 hash
- Format: `{prefix}{key}:ns{X}` where X = hash(key) % num_namespaces
- Helps distribute keys across Redis cluster nodes

**Tag Sharding**:
- Tags are distributed across shards to avoid single large sets
- Shard name: `{prefix}tag:{tag}:shard:{X}` where X = hash(key) % num_shards
- Each shard is a Redis SET containing keys

**Advanced Mode**:
- When enabled, maintains reverse mapping: `{prefix}tags:{finalKey}` → SET of tags
- Required for `getTagsOfKey()` and proper `forget()` with tags

## Critical Bugs Fixed

### 1. Double Namespace Bug in `rememberWithTags()` (CRITICAL)

**Issue**: Cache values were NEVER retrieved from cache

**Root Cause**:
```php
// BUGGY CODE (lines 146-147)
$finalKey = $this->getFinalKey($key, true);  // Transforms: "key" → "prefix:key:ns0"
$value = $this->get($finalKey, $connection_name); // get() transforms AGAIN → "prefix:prefix:key:ns0:ns1"
```

**Fix**:
```php
// CORRECT CODE
$value = $this->get($key, $connection_name, true); // Single transformation in get()
```

**Impact**: All `rememberWithTags()` calls were always executing callbacks, defeating caching purpose.

### 2. Infinite Loop in `getKeys()` 

**Issue**: Method would hang forever when scanning for keys

**Root Cause**:
```php
// BUGGY CODE
$iterator = null;
while ($keys = $redis->scan($iterator, [...]))  // scan() always returns truthy [0, []]
```

**Fix**:
```php
// CORRECT CODE  
$iterator = 0;
do {
    $keys = $redis->scan($iterator, [...]);
    $iterator = $keys[0];
} while ($iterator !== 0);  // Proper termination
```

### 3. Null Array Access in `getOriginalKey()`

**Issue**: `Trying to access array offset on null`

**Root Cause**:
```php
$prefix = config('database.redis.options')['prefix'];  // options might be null
```

**Fix**:
```php
$prefix = config('database.redis.options.prefix', '');  // Dot notation with default
```

## Testing Setup

### Test Environment

**Framework**: Orchestra Testbench for Laravel package testing

**Redis Mocking**: Uses `m6web/redis-mock` with custom wrapper

**Key Challenge**: RedisMock doesn't implement Laravel's Redis Connection interface

### MockRedisConnection Wrapper

Created `MockRedisConnection` class in `tests/Unit/TestCase.php`:

**Purpose**: Bridge between RedisMock and Laravel's Redis facade

**Key Mappings**:
- `flushall()` → `flushdb()` (RedisMock limitation)
- `scan()` options: lowercase → UPPERCASE (RedisMock expects `MATCH`/`COUNT` not `match`/`count`)
- Pipeline support via callback delegation
- Proper method delegation order

**Implementation Details**:
```php
// Options conversion for scan()
if (strtolower($method) === 'scan') {
    if (isset($parameters[1]) && is_array($parameters[1])) {
        $options = [];
        foreach ($parameters[1] as $key => $value) {
            $options[strtoupper($key)] = $value;  // match → MATCH
        }
        $parameters[1] = $options;
    }
}
```

### Test Isolation

**Cleanup**: `tearDown()` calls `flush()` to clean Redis between tests

**Issue**: Tests share the same RedisMock instance across the test class

**Solution**: Each `connection()` call returns a wrapper around the same mock, ensuring state persistence

## CircleCI Configuration

### Previous Issues

1. **Hardcoded Laravel 10**: Conflicted with composer.lock (v12.7.2)
2. **Wrong version parameters**: All set to "10" regardless of matrix
3. **Redis warning**: Extension installed even when already loaded
4. **Incomplete matrix**: Missing PHP/Laravel combinations

### Current Configuration

**Test Matrix**:
- PHP 8.2: Laravel 10, 11
- PHP 8.3: Laravel 10, 11, 12
- PHP 8.4: Laravel 11, 12

**Dynamic Installation**:
```yaml
composer require "laravel/framework:^<<parameters.laravel-version>>.0" --no-update
```

**Redis Extension Check**:
```bash
if php -m | grep -q redis; then
    echo "Redis extension is already loaded, skipping installation"
else
    yes 'no' | sudo pecl install -f redis || true
    sudo docker-php-ext-enable redis
fi
```

## RedisMock Peculiarities

### scan() Implementation

**Behavior**:
- Expects UPPERCASE option keys: `MATCH`, `COUNT`
- With null iterator: Returns only partial results
- With 0 iterator: Returns all matching keys in first call
- Always returns `[nextCursor, keys]` even when empty: `[0, []]`

**Proper Usage**:
```php
$iterator = 0;  // NOT null
do {
    $result = $redis->scan($iterator, ['MATCH' => $pattern, 'COUNT' => 20]);
    $iterator = $result[0];
    // process $result[1]
} while ($iterator !== 0);
```

### Method Availability

**Has**: `flushdb`, `incrby`, `decrby`, `scan`, `get`, `set`, `del`, `exists`, `sadd`, `srem`, `smembers`

**Missing**: `flushall` (map to `flushdb`)

### Key Storage

- Uses static `$dataValues` array indexed by storage name
- State persists within same PHP process
- Array keys are maintained in insertion order

## Important Patterns

### Working with Tags

**Store**:
```php
$this->putWithTags($key, $value, ['tag1', 'tag2'], $ttl);
```

**Retrieve**:
```php
$value = $this->get($key, $connection_name, true);  // isWithTags = true
```

**Remember Pattern**:
```php
$value = $this->rememberWithTags($key, $tags, function() {
    return expensiveOperation();
}, $ttl);
```

### Key Transformation

**Without Tags**: `{prefix}{key}`

**With Tags + Namespace**: `{prefix}{key}:ns{hash}`

**Always use `isWithTags` parameter** when working with tagged cache entries!

### Forget Operations

**Simple key**:
```php
$this->forget($key);  // isWithTags = false
```

**Tagged key**:
```php
$this->forget($key, null, false, true);  // isWithTags = true
```

## Common Pitfalls

1. **Forgetting `isWithTags` flag**: Will look for wrong key format
2. **Using `while` instead of `do-while` for scan**: Infinite loop with RedisMock
3. **Assuming `flushall` exists**: Map to `flushdb` for RedisMock
4. **Lowercase scan options**: RedisMock needs uppercase
5. **Starting scan with `null`**: Use `0` instead
6. **Not checking iterator termination**: Check for `=== 0`, not falsy

## Dependencies

### Production
- Laravel Framework: 9-12 support
- PHP: ^8.0
- predis/predis: ^2.0
- ext-redis: Native Redis extension

### Development
- orchestra/testbench: Laravel package testing
- m6web/redis-mock: Redis mocking for tests
- phpunit/phpunit: ^9.5|^10.0|^11.0

## Test Coverage

**Total Tests**: 18 (all passing)

**Coverage**:
- Basic operations: put, get, has, flush
- Tag operations: putWithTags, getTagsOfKey, flushByTags
- Increment/decrement operations
- Remember pattern: rememberWithTags (4 tests)
- Pattern matching: getKeys
- Namespace handling
- TTL functionality

## Session Achievements

### Pull Request Summary

**Commits**:
1. Fix double namespace bug in rememberWithTags + add tests
2. Fix all unit tests + update CircleCI config

**Changes**:
- Fixed critical cache retrieval bug (100% cache misses)
- Fixed infinite loop in key scanning
- Fixed null pointer in key transformation
- Implemented complete RedisMock integration
- Updated CI/CD for Laravel 10-12 support
- All 18 tests passing (58 assertions)

**Files Modified**:
- `src/SuperCacheManager.php`: Bug fixes in rememberWithTags, getKeys, getOriginalKey
- `tests/Unit/TestCase.php`: MockRedisConnection implementation
- `tests/Unit/SuperCacheManagerTest.php`: Added rememberWithTags tests
- `.circleci/config.yml`: Multi-version Laravel support

## Future Considerations

1. **Performance**: Tag sharding helps, but large tag sets still impact performance
2. **Cluster Support**: Test thoroughly with actual Redis clusters
3. **Namespace Distribution**: Monitor if keys are evenly distributed
4. **Advanced Mode Overhead**: Storing reverse tag mapping increases memory usage
5. **Lock Implementation**: Current lock uses Lua scripts, ensure compatibility

## Quick Reference

### Run Tests
```bash
vendor/bin/phpunit
vendor/bin/phpunit tests/Unit/SuperCacheManagerTest.php
vendor/bin/phpunit --filter=test_remember_with_tags
```

### Debug RedisMock
```php
// In tests
$mock = new RedisMock();
$mock->set('key', 'value');
var_dump($mock->get('key'));
```

### Check CircleCI Locally
```bash
circleci config validate .circleci/config.yml
```

---

*Last Updated: 2026-02-07*  
*Session: Fix cache bugs and CI configuration*
